apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: external-secrets
spec:
  goTemplate: true
  generators:
  - list:
      elements:
      - cluster: in-cluster
        url: https://kubernetes.default.svc
  template:
    metadata:
      name: '{{.cluster}}-external-secrets'
      labels:
        cluster: '{{.cluster}}'
        app: external-secrets
    spec:
      project: default
      info:
      - name: "External Secrets Operator (ESO):"
        value: "Acts as proxy to a Cloud Secrets Store, enabling Kubernetes Secrets creation from secret values stored remotely"
      sources:
      - repoURL: git@github.com:o1-labs/gitops-infrastructure.git
        targetRevision: lsanabria/bootstrap
        path: "charts/external-secrets-operator"
        helm:
          releaseName: external-secrets
          # these values have top precedence
          values: |
            external-secrets:
              commonLabels:
                o1labs.org/gcp-cluster: {{.cluster}}
          valueFiles:
          - values.yaml
          - $otherValues/platform/{{.cluster}}/external-secrets/values.yaml
      - ref: otherValues
        repoURL: git@github.com:o1-labs/gitops-infrastructure.git
        targetRevision: lsanabria/bootstrap
      destination:
        server: '{{.url}}'
        namespace: external-secrets-operator
